---
title: "Download logs"
author: "Emi Tanaka"
date: "24/03/2021"
output: html_document
---

```{r library, include=FALSE}
library(tidyverse)
library(rvest)
library(glue)
library(lubridate)
library(plotly)
library(cranlogs)
library(ggbeeswarm)
knitr::opts_chunk$set(echo = FALSE, 
                      cache = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      cache.path = "cache/")
```

```{r cache, eval = FALSE}
fs::dir_ls("cache") %>% 
  str_subset(".RData$") %>% 
  walk(load)
```




```{r ctv}
doe_pkgs <- ctv:::.get_pkgs_from_ctv_or_repos("ExperimentalDesign", 
                                              repos = "http://cran.rstudio.com/")[[1]]
survey_pkgs <- ctv:::.get_pkgs_from_ctv_or_repos("OfficialStatistics", 
                                              repos = "http://cran.rstudio.com/")[[1]]
npkgs <- length(doe_pkgs)
```

```{r all_pkgs}
url <- "http://cran.rstudio.com/web/packages/packages.rds"
db <- readRDS(url(url)) %>% 
  as.data.frame()
```

```{r extra-pkgs}
exclude_pkgs <- c("argonR", "card", "crispRdesignR", "genotypeR", "genepi", 
                  "agridat", "desplot", "DiceView", "DOS", "DOS2", "EngrExpt")
cdoe_pkgs <- db %>% 
  filter(str_detect(Title, "[dD]esign") | Package %in% doe_pkgs) %>% 
  filter(!Title %in% exclude_pkgs) %>% 
  pull(Package) 
```


```{r cran-data}
end <- Sys.Date() - 2 # usually 1-2 days data are not available yet
start <- end - years(2) + days(2)
dldat <- cran_downloads(doe_pkgs, from = start, to = end)
```

```{r summary}
dldat_sum <- dldat %>% 
  group_by(package) %>% 
  summarise(total = sum(count)) %>% 
  arrange(desc(total)) %>% 
  mutate(rank = 1:n())
```

```{r graph}
g1 <- ggplot(dldat_sum, aes(x = "", y = total/1000, label = package, text = rank)) + 
  geom_beeswarm() +
  scale_y_log10(label = comma) + 
  labs(x = "",
       y = "Download counts in the last 2 year ('000s)") + 
  theme(axis.ticks.length.x = unit(0, "mm"))
ggplotly(g1)
```

```{r updates}
pkg_url <- "https://cran.r-project.org/web/packages/{pkg}/index.html"
pkg_archive <- "https://cran.r-project.org/src/contrib/Archive/{pkg}/"
pkg_updates <- map(doe_pkgs, function(pkg) {
    last_update <- read_html(glue(pkg_url)) %>% 
      html_table() %>% 
      .[[1]] %>% 
      filter(X1=="Published:") %>% 
      pull(X2) %>% 
      ymd()
      
    archive_dates <- tryCatch({ 
        read_html(glue(pkg_archive)) %>% 
          html_table() %>%
          .[[1]] %>% 
          pull(`Last modified`) %>% 
          ymd_hm() %>% 
          na.omit() %>% 
          as.Date()
      }, error = function(e) {
        NULL
      })
    c(archive_dates, last_update)
  })
names(pkg_updates) <- doe_pkgs

updates <- unlist(pkg_updates) %>% 
  enframe("package", "update") %>% 
  # unlist converts date to integers
  mutate(update = as.Date(update, origin = "1970-01-01"),
         # need to get rid of the numbers appended to pkg names
         package = str_extract(package, paste0(doe_pkgs, collapse="|"))) 
```

```{r first}
pkgsum <- updates %>% 
  group_by(package) %>% 
  summarise(first = min(update),
            nupdates = n()) %>% 
  left_join(dldat_sum, by = "package")

g2 <- ggplot(pkgsum, aes(first, total, label = package, text = rank, size = nupdates)) + 
  geom_point(alpha = 0.4) + 
  scale_y_log10() + 
  #geom_smooth() +
  NULL
ggplotly(g2)
```

* Packages released after 2017 September doesn't seem to be listed in CRAN Task View

```{r}
g3 <- ggplot(pkgsum, aes(nupdates, total, label = package, text = rank)) + 
  geom_point(alpha = 0.4) + 
  scale_y_log10() + 
  scale_x_log10() + 
  #geom_smooth() +
  NULL
ggplotly(g3)
```

