---
title: "doe-pkgs-analysis"
author: "Dewi Lestari Amaliah - 31251587"
date: "15/08/2021"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(yaml)
library(reshape)
library(tidyverse)
library(lubridate)
library(splitstackshape)
library(igraph)
library(geomnet)
library(ggnetwork)
library(tidygraph)
library(ggraph)
library(networkD3)
library(plotly)
library(qdapRegex)
library(shiny)
library(visNetwork)
```

```{r}
#load the yml file and transform it as data frame
pkg_df <- yaml.load_file(here::here("data/input/doe-pkgs.yml")) %>%
  melt()

#tidy the data frame
pkg_tidy <- pkg_df %>%
  pivot_wider(names_from = L3,
              values_from = value) %>%
  mutate(author_ulrike = as.factor(ifelse(str_detect(author, "Ulrike"), 1, 0)))

# pivot longer the data frame by its type 
pkg_tidy_long_type <- pkg_tidy %>%
  unnest(type) %>%
  unnest(date) %>%
  unnest(domain) %>%
  mutate(year = year(ymd(date)))
```

```{r}
# summarise the packages based on its type
pkg_tidy_long_type %>%
  filter(relevance != "no") %>%
  group_by(type) %>%
  count() %>%
  arrange(desc(n))
```
```{r}
#summarise the package based on its date of published 
pkg_tidy_long_type %>%
  filter(relevance != "no") %>%
  group_by(year) %>%
  count() %>%
  ggplot(aes(x = year, y = n)) +
  geom_line() +
  geom_point()
```

```{r}
pkg_tidy_long_type %>%
  filter(relevance != "no") %>%
  group_by(domain) %>%
  count() %>%
  arrange(desc(n))
```

```{r}
pkg_tidy_long_main <- pkg_tidy %>%
  unnest(main) %>%
  separate(main, into = c("funct_name", "funct_type", "funct_usage"), sep = ' - ')
```


```{r}
pkg_tidy_long_main %>%
  filter(relevance != "no") %>%
  group_by(funct_type) %>%
  count() %>%
  arrange(desc(n))
```
## Network analysis 

### Create the depends/imports/suggest data frame

```{r}
# make list of doe package 
list_pkg <- as.list(pkg_tidy)$L2

# create function to extract the depends, imports, and suggests 
get_pkg <- function(var){
  # select only the package name and depends/imports/suggests
  tmp_df <- pkg_tidy %>%
    select(L2, author, var) %>%
    # separate every depends/imports/suggests
    cSplit(var, sep = " ,") 
  
  df <- tmp_df %>%
    pivot_longer(c(3:ncol(tmp_df)), names_to = "type", values_to = "pkg") %>%
    filter(!is.na(pkg)) %>%
    # check if the depends/imports/suggests is also a DoE package (is in list_pkg)
    mutate(doe_pkg_related = ifelse(pkg %in% list_pkg, "yes", "no")) %>%
    # filter only package whose depends/imports/suggests is a DoE
    filter(doe_pkg_related == "yes") %>%
    # tidy the data to only have the type: depends/imports/suggests
    cSplit("type", sep = "_") %>%
    select(-type_2) %>%
    rename(type = type_1)

  return(df)
}
```


### Create network data 

```{r}

# create data frame from the above function
depend_df <- get_pkg("depends")
import_df <- get_pkg("imports")
suggest_df <- get_pkg("suggests")

# bind data frames
pkg_edges <- rbind(depend_df, import_df, suggest_df) %>%
  select(-doe_pkg_related) %>%
  select(pkg, L2, type, author)

# extract unique package that has depends/imports/suggests
from <- pkg_edges %>%
  distinct(L2)

# extract unique package that being depends/imports/suggests
to <- pkg_edges %>%
  distinct(pkg)

# create nodes from the two previous dataframe
pkg_nodes_tmp <- full_join(from, to, by = c("L2" = "pkg")) %>%
  left_join(pkg_tidy, by = "L2") %>%
  select(L2, author)

# tidy author 
aut_tidy <- pkg_nodes_tmp %>%
  separate_rows(author, sep=", (?=[A-Z])") %>%
  filter(!str_detect(author, "ctb") & !str_detect(author, "National") & !str_detect(author, "Columbia")) 

aut_tidy$author <- rm_angle(aut_tidy$author, replacement = "")
aut_tidy$author <- rm_square(aut_tidy$author, replacement = "")

aut_tidy <- aut_tidy %>%
  mutate(author = ifelse(str_detect(author, "Contributor"), "Yves Deville",
                         ifelse(str_detect(author, "based"), "Ernesto Barrios",
                                ifelse(str_detect(author, "contributions"), "John Lawson", author))))
                        

aut_group <- aut_tidy %>%
  group_by(author) %>%
  count() %>%
  arrange(desc(n)) %>%
  mutate(aut_gr = as.factor(ifelse(n > 1, author, "other")))

aut_tidy_join <- left_join(aut_tidy, aut_group, by = "author") %>%
  group_by(L2) %>%
  arrange(desc(n), .by_group = TRUE)

pkg_nodes <- aut_tidy_join[!duplicated(aut_tidy_join$L2), ] %>%
  select(L2, aut_gr)
  

# nodes for all of the author in DoE packages
pkg_nodes_full <- pkg_tidy%>%
  select(L2)

# create the network package 
pkg_net <- pkg_edges %>%
  full_join(pkg_nodes, by = "L2")
```


## Create network using igraph

```{r}
routes_igraph <- graph_from_data_frame(d = pkg_edges, vertices = pkg_nodes, directed = TRUE)

# set.seed(1234567)
# plot(routes_igraph, edge.arrow.size = 0.2, layout = layout_with_graphopt)
# Notes: The label overlapped, it is hard to see the network
```


## Create network using tidygraph and ggraph 

```{r}
# create the input based on the igraph object
routes_tidy <- routes_igraph %>% as_tbl_graph() %>%
  activate(edges)

routes_tidy
```


```{r}
ggraph(routes_tidy, layout = "stress") + 
  geom_edge_link(aes(color = type),
                 arrow = arrow(length = unit(1, 'mm')), 
                 end_cap = circle(1, 'mm')) + 
  geom_node_point(aes(color = aut_gr)) + 
  geom_node_text(aes(label = name), repel = TRUE, size = 2) +
  theme_graph()
```

```{r}
aut_tidy_1st_aut <- aut_tidy_join[!duplicated(aut_tidy_join$L2), ] %>%
  select(L2, author) 

aut_gr <- aut_tidy_1st_aut %>%
  group_by(author) %>%
  count() %>%
  ungroup() %>%
  arrange(desc(n)) %>%
  mutate(aut_gr = as.factor(ifelse(n > 1, author, "other")))
  

pkg_nodes_1aut <- left_join(aut_tidy_1st_aut, aut_gr, by = "author") %>%
  select(L2, aut_gr) %>%
  mutate(first_aut = factor(aut_gr, levels = c("Ulrike Groemping",
                                           "John Lawson",
                                           "Robert B. Gramacy",
                                           "Delphine Dupuy",
                                           "Ernesto Barrios",
                                           "Kevin Wright",
                                           "Peng Liu",
                                           "Shwetank Lall",
                                           "other"))) %>%
  select(L2, first_aut)

routes_igraph_1aut <- graph_from_data_frame(d = pkg_edges, vertices = pkg_nodes_1aut, directed = TRUE)

# create the input based on the igraph object
routes_tidy_1aut <- routes_igraph_1aut %>% as_tbl_graph() %>%
  activate(edges)


ggraph(routes_tidy_1aut, layout = "stress") + 
  geom_edge_link(aes(color = type),
                 arrow = arrow(length = unit(1, 'mm')), 
                 end_cap = circle(1, 'mm')) + 
  geom_node_point(aes(color = first_aut)) + 
  geom_node_text(aes(label = name), repel = TRUE, size = 2) +
  theme_graph()
```

















# Network graph with all the packages in CRAN task view

```{r}
routes_igraph_full <- graph_from_data_frame(d = pkg_edges, vertices = pkg_nodes_full, directed = TRUE)

routes_tidy_full <- routes_igraph_full %>% as_tbl_graph() %>%
  activate(edges)

routes_tidy_full
```

```{r}
ggraph(routes_tidy_full, layout = "stress") + 
  geom_edge_link(aes(color = type),
                 arrow = arrow(length = unit(1, 'mm')), 
                 end_cap = circle(1, 'mm')) + 
  geom_node_point() + 
  geom_node_text(aes(label = name), repel = TRUE, size = 2) +
  theme_graph()
```

Note: Hard to read. Hence, with all of the package in CRAN task view, I will make a heatmap instead. 

```{r}
pkg.mat = get.adjacency(routes_igraph_full, sparse = FALSE)
heatmap(pkg.mat[,109:1],Rowv = NA, Colv = NA,scale="none")
```

Next:
1. Color the nodes based on author (Binary variable whether the pkg is authored by Ulrike or not)
2. Using interactive graph with D3
3. Write on the paper 


# Interactive Plot with visnetwork

```{r}
nodes_d3 <- pkg_nodes_1aut %>%
  rowid_to_column("id") %>%
  mutate(id = id - 1)

edges_d3 <-routes_tidy_1aut %>%
  activate(edges) %>%
  data.frame() %>%
  mutate(from = from - 1,
         to = to - 1)

forceNetwork(Links = edges_d3, Nodes = nodes_d3, Source = "from", Target = "to", 
             NodeID = "L2", Group = "first_aut", 
             opacity = 1, fontSize = 16, zoom = TRUE)
```


```{r}
# shinyApp(
#   ui = fluidPage(
#     selectInput("first_aut", "Choose the author:",
#                     choices = levels(pkg_nodes_1aut$first_aut)),
#       mainPanel(plotOutput(outputId = "net"))
#     ),
#   
#   server = function(input, output){
#     
#     dat <- reactive({
#       if (input$first_aut == "Ulrike Groemping"){
#         aut <- pkg_nodes_1aut %>%
#           mutate(author = as.factor(ifelse(first_aut == "Ulrike Groemping", "Ulrike Groemping", "Other")))
#       }
#       
#       if (input$first_aut == "John Lawson"){
#         aut <- pkg_nodes_1aut %>%
#           mutate(author = as.factor(ifelse(first_aut == "John Lawson", "John Lawson", "Other")))
#       }
#       
#       if (input$first_aut == "Robert B. Gramacy"){
#         aut <- pkg_nodes_1aut %>%
#           mutate(author = as.factor(ifelse(first_aut == "Robert B. Gramacy", "Robert B. Gramacy", "Other")))
#       }
#       
#       if (input$first_aut == "Delphine Dupuy"){
#         aut <- pkg_nodes_1aut %>%
#           mutate(author = as.factor(ifelse(first_aut == "Delphine Dupuy", "Delphine Dupuy", "Other")))
#       }
#       
#       if (input$first_aut == "Ernesto Barrios"){
#         aut <- pkg_nodes_1aut %>%
#           mutate(author = as.factor(ifelse(first_aut == "Ernesto Barrios", "Ernesto Barrios", "Other")))
#       }
#       
#       if (input$first_aut == "Kevin Wright"){
#         aut <- pkg_nodes_1aut %>%
#           mutate(author = as.factor(ifelse(first_aut == "Kevin Wright", "Kevin Wright", "Other")))
#       }
#       
#        if (input$first_aut == "Peng Liu"){
#         aut <- pkg_nodes_1aut %>%
#           mutate(author = as.factor(ifelse(first_aut == "Peng Liu", "Peng Liu", "Other")))
#        }
#       
#       if (input$first_aut == "Shwetank Lall"){
#         aut <- pkg_nodes_1aut %>%
#           mutate(author = as.factor(ifelse(first_aut == "Shwetank Lall", "Shwetank Lall", "Other")))
#       }
#       
#       if (input$first_aut == "other"){
#         aut <- pkg_nodes_1aut %>%
#           mutate(author = as.factor(ifelse(first_aut == "other", "Other authors", "Other with > 1 packages")))
#       }
#       
#       graph_from_data_frame(d = pkg_edges, vertices = aut, directed = TRUE) %>%
#         as_tbl_graph() %>% activate(edges)
#     })
#     
#     
# 
#     output$net <- renderPlot(
#       ggraph(dat, layout = "stress") +
#         geom_edge_link(aes(color = type),
#                        arrow = arrow(length = unit(2, 'mm')),
#                        end_cap = circle(1, 'mm')) +
#         geom_node_point(aes(color = author), size = 3) +
#         geom_node_text(aes(label = name), repel = TRUE, size = 3.5) +
#         scale_color_manual(values = c("black", "#6C3483")) +
#         theme_graph()
#     )
#   },
#   
#   options = list(height = 1500,
#                  width = 1500)
#   
# )
```



