---
title: "doe-pkgs-analysis"
author: "Dewi Lestari Amaliah - 31251587"
date: "15/08/2021"
output: html_document
---

```{r setup, include=FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(yaml)
library(reshape)
library(tidyverse)
library(lubridate)
library(splitstackshape)
library(igraph)
library(geomnet)
library(ggnetwork)
library(tidygraph)
library(ggraph)
```

```{r}
#load the yml file and transform it as data frame
pkg_df <- yaml.load_file(here::here("data/input/doe-pkgs.yml")) %>%
  melt()

#tidy the data frame
pkg_tidy <- pkg_df %>%
  pivot_wider(names_from = L3,
              values_from = value)

# pivot longer the data frame by its type 
pkg_tidy_long_type <- pkg_tidy %>%
  unnest(type) %>%
  unnest(date) %>%
  unnest(domain) %>%
  mutate(year = year(ymd(date)))
```

```{r}
# summarise the packages based on its type
pkg_tidy_long_type %>%
  filter(relevance != "no") %>%
  group_by(type) %>%
  count() %>%
  arrange(desc(n))
```
```{r}
#summarise the package based on its date of published 
pkg_tidy_long_type %>%
  filter(relevance != "no") %>%
  group_by(year) %>%
  count() %>%
  ggplot(aes(x = year, y = n)) +
  geom_line() +
  geom_point()
```

```{r}
pkg_tidy_long_type %>%
  filter(relevance != "no") %>%
  group_by(domain) %>%
  count() %>%
  arrange(desc(n))
```

```{r}
pkg_tidy_long_main <- pkg_tidy %>%
  unnest(main) %>%
  separate(main, into = c("funct_name", "funct_type", "funct_usage"), sep = ' - ')
```


```{r}
pkg_tidy_long_main %>%
  filter(relevance != "no") %>%
  group_by(funct_type) %>%
  count() %>%
  arrange(desc(n))
```
## Network analysis 

### Create the depends/imports/suggest data frame

```{r}
# make list of doe package 
list_pkg <- as.list(pkg_tidy)$L2

# create function to extract the depends, imports, and suggests 
get_pkg <- function(var){
  # select only the package name and depends/imports/suggests
  tmp_df <- pkg_tidy %>%
    select(L2, var) %>%
    # separate every depends/imports/suggests
    cSplit(var, sep = " ,") 
  
  df <- tmp_df %>%
    pivot_longer(c(2:ncol(tmp_df)), names_to = "type", values_to = "pkg") %>%
    filter(!is.na(pkg)) %>%
    # check if the depends/imports/suggests is also a DoE package (is in list_pkg)
    mutate(doe_pkg_related = ifelse(pkg %in% list_pkg, "yes", "no")) %>%
    # filter only package whose depends/imports/suggests is a DoE
    filter(doe_pkg_related == "yes") %>%
    # tidy the data to only have the type: depends/imports/suggests
    cSplit("type", sep = "_") %>%
    select(-type_2) %>%
    rename(type = type_1)

  return(df)
}
```


### Create network data 

```{r}

# create data frame from the above function
depend_df <- get_pkg("depends")
import_df <- get_pkg("imports")
suggest_df <- get_pkg("suggests")

# bind data frames
pkg_edges <- rbind(depend_df, import_df, suggest_df) %>%
  select(-doe_pkg_related)

# extract unique package that has depends/imports/suggests
from <- pkg_edges %>%
  distinct(L2)

# extract unique package that being depends/imports/suggests
to <- pkg_edges %>%
  distinct(pkg)

# create nodes from the two previous dataframe
pkg_nodes <- full_join(from, to, by = c("L2" = "pkg"))

pkg_nodes_full <- pkg_tidy %>%
  select(L2)

# create the network package 
pkg_net <- pkg_edges %>%
  full_join(pkg_nodes, by = "L2")
```


## Create network using geomnet

```{r}
set.seed(12345)
ggplot(pkg_net, aes(from_id = L2, to_id = pkg)) +
  geom_net(layout.alg = "kamadakawai",
    size = 2, 
    labelon = TRUE, 
    vjust = -0.6, 
    directed = FALSE, 
    fontsize = 2)
```

Note: This method results error, and only works with the edges only. However, even with the example data, the error stil occurs (may be the bug in the package?)

```{r}
## Example of issue in geomnet

edges <- madmen$edges
nodes <- madmen$vertices

madmen_net <- fortify(as.edgedf(edges), nodes)

set.seed(12345)
ggplot(madmen_net, aes(from_id = from_id, to_id = to_id)) +
  geom_net(layout.alg = "kamadakawai",
    size = 2, 
    labelon = TRUE, 
    vjust = -0.6, 
    directed = FALSE, 
    fontsize = 2)
```


## Create network using igraph

```{r}
routes_igraph <- graph_from_data_frame(d = pkg_edges, vertices = pkg_nodes, directed = TRUE)

set.seed(1234567)
plot(routes_igraph, edge.arrow.size = 0.2, layout = layout_with_graphopt)
```
Notes: The label overlapped, it is hard to see the network


## Create network using tidygraph and ggraph 

```{r}
# create the input based on the igraph object
routes_tidy <- routes_igraph %>% as_tbl_graph() %>%
  activate(edges)

routes_tidy
```


```{r}
ggraph(routes_tidy, layout = "stress") + 
  geom_edge_link(aes(color = type),
                 arrow = arrow(length = unit(1, 'mm')), 
                 end_cap = circle(1, 'mm')) + 
  geom_node_point() + 
  geom_node_text(aes(label = name), repel = TRUE, size = 2) +
  theme_graph()
```

# Network graph with all the packages in CRAN task view

```{r}
routes_igraph_full <- graph_from_data_frame(d = pkg_edges, vertices = pkg_nodes_full, directed = TRUE)

routes_tidy_full <- routes_igraph_full %>% as_tbl_graph() %>%
  activate(edges)

routes_tidy_full
```

```{r}
ggraph(routes_tidy_full, layout = "stress") + 
  geom_edge_link(aes(color = type),
                 arrow = arrow(length = unit(1, 'mm')), 
                 end_cap = circle(1, 'mm')) + 
  geom_node_point() + 
  geom_node_text(aes(label = name), repel = TRUE, size = 2) +
  theme_graph()
```

Note: Hard to read. Hence, with all of the package in CRAN task view, I will make a heatmap instead. 

```{r}
pkg.mat = get.adjacency(routes_igraph_full, sparse = FALSE)
heatmap(pkg.mat[,109:1],Rowv = NA, Colv = NA,scale="none")
```

