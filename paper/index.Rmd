---
title: Current status and propsects of R-packages for the design of experiments
author:
  - name: Emi Tanaka
    affiliation: Monash University
abstract: >
    Re-running an experiment is generally costly and in some cases impossible due to limited resources, so the design of an experiment plays a critical role in increasing the quality of experimental data.  In this article we describe the current state of the R-packages for the design of experiments through textual analysis and assessment of download trends. We discuss also the software design of widely utilised R packages in the field of experimental design and conclude with discussion of some future prospects for the field.
bibliography: paper.bib

output: 
  bookdown::html_document2:
    theme: paper
---

```{r setup, cache = FALSE, include = FALSE}
library(tidyverse)
library(rvest)
library(lubridate)
library(cranlogs)
library(glue)
library(scales)
library(colorspace)
library(tidytext)
library(pluralize)
library(kableExtra)
library(igraph)
library(ggraph)
library(ggrepel)
library(patchwork)
library(ggwordcloud)
tocache <- TRUE
knitr::opts_chunk$set(echo = FALSE, 
                      cache = FALSE,
                      cache.path = "cache/",
                      fig.align = 'center', 
                      fig.pos = 'htbp', 
                      fig.path = "figures/",
                      fig.width = 6,
                      message = FALSE,
                      warning = FALSE)

theme_set(
  theme(panel.background = element_rect(fill = NA),
        panel.grid = element_line(color = "lightgray"),
        axis.text = element_text(color = "black"),
        axis.line = element_line(color = "black", size = 0.7),
        axis.ticks.length = unit(1.4, "mm"),
        axis.ticks = element_line(color = "black", size = 0.7),
        axis.title = element_text(color = "black", face = "bold"),
        strip.background = element_rect(color = "black",
                                        fill = "white"),
        strip.text = element_text(color = "black", 
                                  margin = margin(5, 5, 5, 5)),
        plot.title.position = "plot",
        plot.title = element_text(color = "black", hjust = 0)))

ctv <- function(view) {
  ifelse(knitr::is_html_output(), glue("[{view}](https://cran.r-project.org/web/views/{view}.html)"), glue("\\ctv{[view]}", .open = "[", .close = "]"))
}
CRANpkg <- function(pkg) {
  ifelse(knitr::is_html_output(), glue("[{pkg}](https://cran.r-project.org/web/packages/{pkg}/index.html)"), glue("\\CRANpkg{[pkg]}", .open = "[", .close = "]"))
}
ref <- function(x) {
  ifelse(knitr::is_html_output(), glue("\\@ref({x})"), glue("\\ref{[x]}", .open = "[", .close = "]"))
}
```

```{r ctv}
doe_pkgs <- ctv:::.get_pkgs_from_ctv_or_repos("ExperimentalDesign", 
                                              repos = "http://cran.rstudio.com/")[[1]]
doe_pkgs <- c(doe_pkgs, "DeclareDesign")
npkgs <- length(doe_pkgs)
```

```{r cran-data, cache = tocache}
end <- Sys.Date() - 3 # usually 1-2 days data are not available yet
start <- end - years(2)
dldat <- cran_downloads(doe_pkgs, from = start, to = end)
```

```{r cran-data2, cache = tocache}
start2 <- end - years(5) 
dldat2 <- cran_downloads(doe_pkgs, from = start2, to = end)
```

```{r data-summary}
dldat_sum <- dldat %>% 
  group_by(package) %>% 
  summarise(total = sum(count)) %>% 
  arrange(desc(total)) %>% 
  mutate(rank = 1:n())

dldat_sum5 <- dldat2 %>% 
  group_by(package) %>% 
  summarise(total = sum(count)) %>% 
  arrange(desc(total)) %>% 
  mutate(rank = 1:n())

top_2years <- pull(dldat_sum, package)
top_5years <- pull(dldat_sum5, package)
```

```{r pkg-updates, cache = tocache}
ntop <- 8
pkg_url <- "https://cran.r-project.org/web/packages/{pkg}/index.html"
pkg_archive <- "https://cran.r-project.org/src/contrib/Archive/{pkg}/"
pkg_updates <- map(top_2years[1:ntop], function(pkg) {
    last_update <- read_html(glue(pkg_url)) %>% 
      html_table() %>% 
      .[[1]] %>% 
      filter(X1=="Published:") %>% 
      pull(X2) %>% 
      ymd()
      
    archive_dates <- tryCatch({ 
        read_html(glue(pkg_archive)) %>% 
          html_table() %>%
          .[[1]] %>% 
          pull(`Last modified`) %>% 
          ymd_hm() %>% 
          na.omit() %>% 
          as.Date()
      }, error = function(e) {
        NULL
      })
    c(archive_dates, last_update)
  })
names(pkg_updates) <- top_2years[1:ntop]

updates <- unlist(pkg_updates) %>% 
  enframe("package", "update") %>% 
  # unlist converts date to integers
  mutate(update = as.Date(update, origin = "1970-01-01"),
         # need to get rid of the numbers appended to pkg names
         package = str_extract(package, paste0(top_2years[1:ntop], collapse="|")),
         package = factor(package, levels = top_2years[1:ntop])) %>% 
  filter(between(update, start2, end))

```


# Introduction 

The critical role of data collection is well captured in the expression "garbage in, garbage out" -- in other words, if the collected data is rubbish then no analysis, however complex it may be, can make something out of it. Methods for data collection can be dichotomised by the type of data collected -- namely, experimental or observational -- or alternatively, categorised as experimental design (including quasi-experimental design) or survey design. This dichotomisation, to a great extent, is seen in [CRAN task views](https://cran.r-project.org/web/views/) where R-packages in experimental design are in `r ctv("ExperimentalDesign")` and R-packages in survey designs are in `r ctv("OfficialStatistics")`. Survey designs often, although not always, aim to collect observational data whilst experimental designs exclusively center on experimental data where the subject and experimental factors tend to be in the control of the experimenter. This paper is concerned with the latter.


In the CRAN task view of `r ctv("ExperimentalDesign")`, there are `r npkgs` R packages for experimental design and analysis of data from experiments, henceforth referred to as "**DoE packages**" in this paper. The sheer quantity and variation in the output experimental design in the R-packages are arguably unmatched with any other programming languages, e.g. in Python [@python], only a handful of libraries that generate design of experiment exist (namely `pyDOE`, `pyDOE2`, `dexpy`, `experimenter` and `GPdoemd`) with limited outputs. Thus, the study of DoE packages is also revealing into the current status of the field of experimental design.

The paper is organised as follows. Section \@ref(eda) explores some analysis of the most downloaded DoE packages, followed by discussion of the discussion of the software design of these packages in Section \@ref(design), and concluding with a discussion in Section \@ref(discussion) of future prospects. 


# Explorative analysis {#eda}

The Comprehensive R Archive Network (CRAN) is a network of servers located across the world that store R and R-packages. 

```{r download-trend, fig.width = 10,  dependson = "cran-data", fig.height = 8}
dldat2 %>% 
  filter(package %in% top_2years[1:ntop]) %>% 
  mutate(package = factor(package, levels = top_2years[1:ntop])) %>%
ggplot(aes(date, count + 1)) +
  geom_line(data = rename(dldat2, pkg = package),
            color = "grey80",
            aes(group = pkg)) +
  geom_line(data = ~rename(., pkg = package),
            color = "grey60",
            aes(group = pkg)) +
  geom_vline(data = updates, 
             aes(xintercept = update),
             color = "red", linetype = "dashed") +
  geom_line() +
  scale_y_log10() +
  scale_x_date(expand = c(0, 0)) + 
  facet_grid(package ~ .) +
  theme(legend.position = "bottom")
```



```{r download-dist, dependson = "cran-data"}


dl1plot <- ggplot(dldat_sum, aes(x = "", y = total/1000)) + 
  geom_violin() +
  geom_boxplot(width = 0.1) + 
  scale_y_log10(label = comma) + 
  labs(x = "",
       y = "Download counts in the last 2 year ('000s)", title = "(A)") + 
  geom_text_repel(data = ~slice_max(., total, n = 13), 
                  nudge_x = rep(c(0.2, -0.2, 0.2, -0.2, 0.15), c(3, 2, 2, 3, 3)),
                  size = 4,
                  aes(label = package)) + 
  theme(axis.ticks.length.x = unit(0, "mm"))




top15 <- dldat_sum %>% 
  left_join(dldat_sum5, by = "package") %>% 
  slice_max(total.x + total.y, n = 15) %>% 
  select(package, rank.x, rank.y) %>% 
  pivot_longer(-package) %>% 
  mutate(name = ifelse(name=="rank.x", "Last 2 years", "Last 5 years"))

dl2plot <- ggplot(top15, aes(name, value, group = package)) +
  geom_line() + 
  geom_point() +
  scale_y_reverse(breaks = 1:15) +
  scale_x_discrete(expand = expansion(c(0.1, 0.5))) +
  labs(x = "", y = "Ranking", title = "(B)") +
  geom_text(data = ~filter(., name=="Last 5 years"),
            aes(label = package), 
            hjust = 0, 
            nudge_x = 0.1,
            size = 4) + 
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())
```

```{r dlplots, fig.cap=glue("The above graph shows the total download counts from {start} to {end} of DoE packages."), fig.width = 6}
dl1plot + dl2plot
```

```{r text, cache=tocache}
url <- "http://cran.rstudio.com/web/packages/packages.rds"
db <- readRDS(url(url)) %>% 
  as.data.frame()

doe_db <- db %>% 
  filter(Package %in% doe_pkgs) %>% 
  mutate(Description = str_replace_all(Description, "\n", " "),
         Description = str_squish(Description),
         Title = str_replace_all(Title, "\n", " "))
```

```{r fns}
singularize2 <- function(x) {
    res <- singularize(x)
    res <- ifelse(res=="bia", "bias", res)
    ifelse(res=="baye", "bayes", res)
}
stop_words_rex <- c(paste0("^", stop_words$word, "$"), "^doi", "^[0-9.]+$")
get_ngram <- function(ngram, desc = c("Title", "Description")) {
  desc <- match.arg(desc)
  words <- paste0("word", 1:ngram)
  doe_db %>% 
    unnest_tokens(word, desc, token = "ngrams", n = ngram) %>% 
    separate(word, words, sep = " ") %>% 
    mutate(across(num_range("word", 1:ngram), singularize2)) %>% 
    distinct(!!!map(c("Package", words), as.name)) %>% 
    # allow stop words in between
    filter(if_all(num_range("word", c(1, ngram)), 
                  ~!str_detect(., paste0(stop_words_rex, collapse = "|")))) %>% 
    count(!!!map(words, as.name), sort = TRUE) %>% 
    mutate(word = do.call("paste", map(words, ~eval(parse(text = .x))))) %>% 
    select(word, n) 
}

combine_dl <- function(ngram_df, desc) {
  dldat_sum %>% 
    left_join(doe_db, by = c("package" = "Package")) %>% 
    select(package, total, {{desc}}) %>% 
    mutate(bigram_title = map({{desc}}, ~filter(ngram_df, 
                                              n > 1,
                                              str_detect(tolower(.x), word)))) %>% 
    unnest_longer(bigram_title) %>% 
    unpack(bigram_title) %>% 
    group_by(word) %>% 
    summarise(n = unique(n),
              pkgs = list(package),
              total = sum(total)) %>% 
    filter(!is.na(word)) %>% 
    arrange(desc(total))
}
```

```{r ngrams, cache=tocache, dependson="fns"}
bigram_title <- get_ngram(2, "Title")
bigram_desc <- get_ngram(2, "Description")
trigram_desc <- get_ngram(3, "Description")
```

* Not much difference between title and description.
* Just go with description and combine bi & tri.

```{r wordcloud, fig.height = 3.3}
dldat_comb_bigram_title <- combine_dl(bigram_title, Title)
dldat_comb_bigram_desc <- combine_dl(bigram_desc, Title)
dldat_comb_trigram_desc <- combine_dl(trigram_desc, Title)

set.seed(1)
ggplot(rbind(dldat_comb_bigram_desc,
             dldat_comb_trigram_desc),
       aes(label = word, size = total, color = n)) +
  geom_text_wordcloud(shape = "square",
                      show.legend = TRUE) +
  scale_size_area(max_size = 8) +
  guides(size = FALSE) +
  scale_color_continuous(breaks = 1:11) +
  theme(legend.position = "bottom")
```


## What are the common types of experimental designs?

## How do packages interplay with each other?

## Which packages are widely utilised?

Figure `r ref("fig:dlplots")` suggests that the `r CRANpkg("AlgDesign")` followed by `r CRANpkg("agricolae")` are far more downloaded than any other DoE packages. It is worth noting that `r CRANpkg("agricolae")` imports `r CRANpkg("AlgDesign")` thus any download of `r CRANpkg("agricolae")` likely results also in a download of `r CRANpkg("AlgDesign")`. 

# Software design {#design}



# Discussion {#discussion}

The analysis showed that ... . There are several limitations to the exploratory analysis. These include that the download data are limited to the RStudio CRAN download logs, one of XXX mirrors (albeit most popular), and the study is based on CRAN packages listed in the DoE CRAN task view -- there may well be some R-packages that are not on CRAN or part of the task view. Further exploration could expand the study for packages that may be outside this list. 

An experiment involves running a number of steps:

1. Defining the hypothesis or question
2. Formulating methods to test hypothesis or answer question 
3. Planning the experimental protocol:
  * Determining experimental resources, 
  * specifying the data collection procedure,
  * constructing the experimental design layout, and
  * proposing a model for analysis.
4. Collect data 
5. Analyse data, interpret result and conclusion


\newpage



```{r cran-titles}
url <- "http://cran.rstudio.com/web/packages/packages.rds"
db <- readRDS(url(url)) %>% 
  as.data.frame()
```

```{r bigram}
stop_words_ext <- c(stop_words$word, "doi")

doe_db <- db %>% 
  filter(Package %in% doe_pkgs) %>% 
  mutate(Description = str_replace_all(Description, "\n", " "),
         Description = str_squish(Description),
         Title = str_replace_all(Title, "\n", " "))

bigram_tab <- function(data, col) {
  data %>% 
    unnest_tokens(word, {{col}}, token = "ngrams", n = 2) %>% 
    separate(word, c("word1", "word2"), sep = " ") %>% 
    mutate(word1 = singularize(word1),
           word2 = singularize(word2)) %>% 
    # don't count the same bigram within the same package
    distinct(Package, word1, word2) %>% 
    filter(!word1 %in% stop_words_ext,
           !word2 %in% stop_words_ext,
           !str_detect(word1, "^[0-9.]+$"),
           !str_detect(word2, "^[0-9.]+$")) %>% 
    count(word1, word2, sort = TRUE)  
}
```

```{r bigram-title, results="asis"}
btitle <- bigram_tab(doe_db, Title) %>% 
  filter(n > 3) %>% 
  mutate(word = paste(word1, word2)) %>% 
  select(word, n) %>% 
  kbl(booktabs = TRUE, linesep = "")

bdesc <- bigram_tab(doe_db, Description) %>% 
  filter(n > 4) %>% 
  mutate(word = paste(word1, word2)) %>% 
  select(word, n) %>% 
  kbl(booktabs = TRUE, linesep = "")

cat(c("\\begin{table}[h] \\centering ", 
      btitle,
    "\\hspace{1cm} \\centering ",
      bdesc,
    "\\caption{My tables} \\end{table}")) 
```

```{r}
doe_imports <- doe_db %>% 
  mutate(Depends = str_replace_all(Depends, "\n", " "),
         Depends = str_replace_all(Depends, fixed("("), " ("),
         Imports = str_replace_all(Imports, "\n", " "),
         Imports = str_replace_all(Imports, fixed("("), " ("),
         imports = str_c(Depends, Imports, sep = ","),
         imports = str_split(imports, ","),
         imports = map(imports, ~{
           str_squish(.x) %>% 
             word() %>% 
             .[.!=""]}
         ),
         imports_doe = map(imports, ~.x[.x %in% doe_pkgs])) %>% 
  select(Package, imports_doe) %>% 
  unnest_longer(imports_doe) %>% 
  filter(!is.na(imports_doe)) %>% 
  rename(from = imports_doe, to = Package) %>% 
  select(from, to)
```

```{r doe-network, eval = FALSE}
graph_from_data_frame(doe_imports) %>% 
  ggraph(layout = 'fr') +
  geom_edge_link(aes(start_cap = label_rect(node1.name),
                     end_cap = label_rect(node2.name)), 
                 arrow = arrow(length = unit(2, 'mm')),
                 color = "#79003e") + 
  geom_node_text(aes(label = name),
                 color = "#79003e") +
  theme(panel.background = element_rect(fill = "#f6e5ee",
                                        color = "#79003e"),
        plot.margin = margin(20, 20, 20, 20))
```





